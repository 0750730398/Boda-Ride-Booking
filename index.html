<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jinja Boda B Booking and Special Car Hire</title>

<style>
body { font-family: "Segoe UI", sans-serif; background: #f9fafb; margin: 0; }
header { background: linear-gradient(135deg, #0f766e, #14b8a6); color: white; text-align: center; padding: 20px; }
nav { display: flex; justify-content: center; gap: 10px; margin: 10px 0; }
nav button { padding: 10px 15px; border: none; border-radius: 8px; background: #0f766e; color: white; cursor: pointer; }
.container { max-width: 550px; margin: auto; padding: 20px; }
.card { background: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; }
input, select { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 10px; border: 1px solid #d1d5db; }
button.submit, button.action { width: 100%; padding: 12px; border: none; border-radius: 12px; background: #0f766e; color: white; font-weight: bold; margin-top: 5px; cursor: pointer; }
button.delete { background: #dc2626; }
.booking, .rider { background: #f3f4f6; padding: 12px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #d1d5db; }
.registration-choice button { background: #14b8a6; margin: 10px 0; }
</style>
</head>

<body>

<header>
<h1>Jinja Boda B Booking and Special Car Hire</h1>
<p>Ride Safe â€¢ Arrive on Time â€¢ Support Local Riders</p>
</header>

<nav>
<button onclick="showSection('book')">Book Ride</button>
<button onclick="showSection('riderLogin')">Riders/Drivers</button>
<button onclick="openAdmin()">Admin</button>
</nav>

<div class="container">

<!-- BOOK -->
<div id="book" class="card section">
<h2>Book a Ride</h2>
<input id="custName" placeholder="Your Name">
<input id="custPhone" placeholder="Phone Number">
<input id="pickup" placeholder="Pickup Location">
<input id="destination" placeholder="Destination">

<select id="rideType">
<option value="Motorcycle">Motorcycle</option>
<option value="Car">Car</option>
</select>

<select id="time">
<option>Now</option>
<option>In 15 minutes</option>
<option>In 30 minutes</option>
</select>
<button class="submit" onclick="bookRide()">Submit Booking</button>
</div>

<!-- RIDER LOGIN -->
<div id="riderLogin" class="card section" style="display:none;">
<h2>Rider / Admin Login</h2>
<p>Riders: enter your bike plate. Admin: enter PIN</p>
<input id="loginInput" placeholder="Bike Plate or Admin PIN">
<button class="submit" onclick="riderOrAdminLogin()">Login</button>
</div>

<!-- RIDER DASHBOARD -->
<div id="rider" class="card section" style="display:none;">
<h2>Rider Dashboard</h2>
<p>Update location only:</p>
<input id="updatePlate" placeholder="Your Bike Plate">
<button class="submit" onclick="updateMyLocation()">Update My Location</button>
<hr>
<h3>Registered Riders</h3>
<div id="riderProfiles"></div>

<hr>
<h3>Assigned Bookings</h3>
<div id="riderBookings"></div>
</div>

<!-- ADMIN DASHBOARD -->
<div id="admin" class="card section" style="display:none;">
<h2>Admin Dashboard</h2>

<h3>Choose Registration Type</h3>
<div class="registration-choice">
<button onclick="showRegistration('motorcycle')">Register Motorcycle Rider</button>
<button onclick="showRegistration('car')">Register Car Driver</button>
</div>

<!-- MOTORCYCLE RIDER FORM -->
<div id="motorcycleForm" style="display:none;">
<h3>Add Motorcycle Rider</h3>
<input id="riderName" placeholder="Rider Name">
<input id="riderPhone" placeholder="Phone (07XXXXXXXX)">
<input id="vehicle" placeholder="Bike Plate Number">
<input id="riderNIN" placeholder="NIN (Optional)">
<button class="submit" onclick="addRider('Motorcycle')">Add Rider</button>
</div>

<!-- CAR DRIVER FORM -->
<div id="carForm" style="display:none;">
<h3>Add Car Driver</h3>
<input id="driverName" placeholder="Driver Name">
<input id="driverPhone" placeholder="Phone (07XXXXXXXX)">
<input id="carPlate" placeholder="Car Plate Number">
<select id="carType">
<option value="Sedan">Sedan</option>
<option value="SUV">SUV</option>
<option value="Van">Van</option>
<option value="Pickup">Pickup</option>
</select>
<input id="driverNIN" placeholder="NIN (Optional)">
<button class="submit" onclick="addRider('Car')">Add Driver</button>
</div>

<hr>
<h3>Search Riders by Bike/Car Plate</h3>
<input id="searchPlate" placeholder="Type plate to search..." oninput="searchRidersByPlate()">

<hr>
<h3>Registered Riders/Drivers</h3>
<div id="riderProfilesAdmin"></div>

<hr>
<h3>Bookings</h3>
<div id="bookingList"></div>
</div>

</div>

<script>
const ADMIN_PIN = "1234";
let currentRider = null;
let showAllBookings = false;

// === SHOW REGISTRATION FORM ===
function showRegistration(type){
    document.getElementById('motorcycleForm').style.display = (type==='motorcycle')?'block':'none';
    document.getElementById('carForm').style.display = (type==='car')?'block':'none';
}

// === SECTION CONTROL ===
function showSection(id){
    document.querySelectorAll('.section').forEach(s=>s.style.display='none');
    document.getElementById(id).style.display='block';
    if(id==="rider") { loadRiders(); loadRiderBookings(); }
    if(id==="admin") { loadRiders(); loadAdminRiders(); loadAdmin(); }
}

// === ADMIN LOGIN FUNCTION ===
function openAdmin(){
    const pin = prompt("Enter Admin PIN");
    if(pin === ADMIN_PIN){
        showSection('admin');
    } else {
        alert("Wrong PIN");
    }
}

// === RIDER OR ADMIN LOGIN ===
function riderOrAdminLogin(){
    const val = document.getElementById('loginInput').value.trim();
    if(!val){ alert("Enter bike plate or admin PIN"); return; }
    if(val === ADMIN_PIN){ showSection('admin'); return; }
    const riders = getRiders();
    const rider = riders.find(r => r.plate && r.plate.trim().toLowerCase() === val.toLowerCase());
    if(rider){ currentRider = rider; showSection('rider'); loadRiders(); loadRiderBookings(); }
    else { alert("Plate not registered or deleted. Contact admin."); }
}

// === STORAGE ===
const getRiders = () => JSON.parse(localStorage.getItem('riders')||'[]');
const getBookings = () => JSON.parse(localStorage.getItem('bookings')||'[]');

// === ADD RIDER/DRIVER ===
function addRider(type){
    navigator.geolocation.getCurrentPosition(pos=>{
        let riders = getRiders();
        let name, phone, plate, nin, vehicleType;
        if(type==='Motorcycle'){
            name = riderName.value.trim();
            phone = riderPhone.value.trim();
            plate = vehicle.value.trim();
            nin = riderNIN.value.trim();
        } else {
            name = driverName.value.trim();
            phone = driverPhone.value.trim();
            plate = carPlate.value.trim();
            vehicleType = document.getElementById('carType').value;
            nin = driverNIN.value.trim();
        }

        if(riders.find(r=>r.plate && r.plate.trim().toLowerCase()===plate.toLowerCase())){
            alert("Rider/Driver already exists");
            return;
        }

        const systemNumber = (type==='Motorcycle'?'RIDER':'DRIVER') + "-" + Date.now() + "-" + Math.floor(Math.random()*900 + 100);

        riders.push({
            id: Date.now(),
            systemId: systemNumber,
            name, phone,
            plate,
            type,
            vehicleType: vehicleType || '',
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            nin: nin || ""
        });

        localStorage.setItem('riders', JSON.stringify(riders));
        alert(`${type} added successfully. System ID: ${systemNumber}`);
        loadRiders();
        loadAdminRiders();
    });
}

// === RIDER UPDATE LOCATION ===
function updateMyLocation(){
    const plate = document.getElementById('updatePlate').value.trim();
    if(!plate){ alert("Enter your plate"); return; }
    navigator.geolocation.getCurrentPosition(pos=>{
        let riders = getRiders();
        let rider = riders.find(r => r.plate && r.plate.trim().toLowerCase() === plate.toLowerCase());
        if(!rider){ alert("Plate not registered. Contact admin."); return; }
        rider.lat = pos.coords.latitude;
        rider.lng = pos.coords.longitude;
        localStorage.setItem('riders',JSON.stringify(riders));
        alert("Location updated successfully");
        loadRiders();
        loadAdminRiders();
    });
}

// === LOAD RIDERS FOR DASHBOARDS ===
function loadRiders(){
    const riders = getRiders();
    document.getElementById('riderProfiles').innerHTML = riders.map(r=>`
        <div class="rider">
            <b>${r.name}</b><br>
            ğŸ“ ${r.phone}<br>
            ${r.type==='Motorcycle'?'ğŸï¸':'ğŸš—'} ${r.plate}<br>
            ${r.vehicleType? "Type: "+r.vehicleType+"<br>":""}
            ${r.nin ? "ğŸ†” NIN: " + r.nin + "<br>" : ""}
            ğŸ†” System ID: ${r.systemId}<br>
            ğŸ“ Location active
        </div>
    `).join('') || "<p>No riders registered</p>";
}

// === LOAD RIDER BOOKINGS ===
function loadRiderBookings(){
    if(!currentRider){ document.getElementById('riderBookings').innerHTML = "<p>No bookings assigned</p>"; return; }
    const bookings = getBookings().filter(b => b.rider && b.rider.plate === currentRider.plate);
    document.getElementById('riderBookings').innerHTML = bookings.map(b=>`
        <div class="booking">
            <b>${b.customer}</b><br>
            ${b.pickup} â†’ ${b.destination}<br>
            Type: ${b.type}<br>
            â° ${b.time}<br>
            ğŸš¦ <b>${b.status}</b>
        </div>
    `).join('') || "<p>No bookings assigned</p>";
}

// === ADMIN RIDER LIST ===
function loadAdminRiders(filteredRiders=null){
    const riders = filteredRiders || getRiders();
    document.getElementById('riderProfilesAdmin').innerHTML = riders.map(r=>`
        <div class="rider">
            <b>${r.name}</b> | ${r.type==='Motorcycle'?'ğŸï¸':'ğŸš—'} ${r.plate} | ğŸ“ ${r.phone} ${r.vehicleType? "| Type: "+r.vehicleType:""} ${r.nin ? " | NIN: " + r.nin : ""} | ğŸ†” ${r.systemId}<br>
            <button class="delete" onclick="deleteRider('${r.plate}')">Delete</button>
        </div>
    `).join('') || "<p>No riders registered</p>";
}

// === SEARCH RIDERS ===
function searchRidersByPlate(){
    const query = document.getElementById('searchPlate').value.trim().toLowerCase();
    const riders = getRiders().filter(r => r.plate && r.plate.toLowerCase().includes(query));
    loadAdminRiders(riders);
}

// === DELETE RIDER ===
function deleteRider(plate){
    if(!confirm("Are you sure?")) return;
    let riders = getRiders().filter(r => (r.plate || "").replace(/\s+/g,'').toLowerCase() !== plate.toLowerCase());
    if(currentRider && currentRider.plate.toLowerCase() === plate.toLowerCase()){ currentRider=null; showSection('riderLogin'); alert("Deleted rider logged out."); }
    else { alert("Deleted successfully"); }
    localStorage.setItem('riders',JSON.stringify(riders));
    loadRiders();
    loadAdminRiders();
}

// === BOOK RIDE ===
function bookRide(){
    if(!custName.value||!custPhone.value||!pickup.value||!destination.value){ alert("Fill all fields"); return; }
    const bookings = getBookings();
    bookings.push({
        id: Date.now(),
        customer: custName.value,
        phone: custPhone.value,
        pickup: pickup.value,
        destination: destination.value,
        type: rideType.value,
        time: time.value,
        status: "Pending",
        rider: null
    });
    localStorage.setItem('bookings',JSON.stringify(bookings));
    alert("Booking received");
    custName.value=custPhone.value=pickup.value=destination.value="";
}

// === ADMIN BOOKINGS ===
function loadAdmin(){
    let bookings = getBookings().sort((a,b) => b.id - a.id);
    let displayBookings = showAllBookings ? bookings : bookings.slice(0,5);
    bookingList.innerHTML = displayBookings.map(b=>`
        <div class="booking">
            <b>${b.customer}</b><br>
            ${b.pickup} â†’ ${b.destination}<br>
            Type: ${b.type}<br>
            â° ${b.time}<br>
            ğŸš¦ <b>${b.status}</b><br>
            ${b.status==="Pending"?`<button class="action" onclick="assignNearest(${b.id})">Assign Nearest Rider</button>`:""}
            ${b.status==="Accepted"?`<button class="action complete" onclick="markCompleted(${b.id})">Trip Completed</button>`:""}
        </div>
    `).join('') || "<p>No bookings</p>";

    if(bookings.length>5){ const btnText = showAllBookings ? "Hide Older Bookings" : "View Older Bookings"; bookingList.innerHTML += `<button class="action" style="margin-top:10px;" onclick="toggleOlderBookings()">${btnText}</button>`; }
}

// === TOGGLE OLDER BOOKINGS ===
function toggleOlderBookings(){ showAllBookings=!showAllBookings; loadAdmin(); }

// === DISTANCE ===
function distance(a,b){
    const R=6371;
    const dLat=(b.lat-a.lat)*Math.PI/180;
    const dLng=(b.lng-a.lng)*Math.PI/180;
    const s=Math.sin(dLat/2)**2+Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.sin(dLng/2)**2;
    return R*2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));
}

// === ASSIGN NEAREST RIDER ===
function assignNearest(id){
    const bookings=getBookings();
    const riders=getRiders();
    const booking=bookings.find(b=>b.id===id);
    if(!riders.length){ alert("No riders available"); return; }
    navigator.geolocation.getCurrentPosition(pos=>{
        let nearest=null,min=Infinity;
        riders.forEach(r=>{
            const d=distance({lat:pos.coords.latitude,lng:pos.coords.longitude},r);
            if(d<min){min=d;nearest=r;}
        });
        booking.rider=nearest; booking.status="Accepted";
        localStorage.setItem('bookings',JSON.stringify(bookings));
        loadAdmin(); loadRiderBookings();
    });
}

// === COMPLETE ===
function markCompleted(id){
    const b=getBookings();
    b.find(x=>x.id===id).status="Completed";
    localStorage.setItem('bookings',JSON.stringify(b));
    loadAdmin();
}

// DEFAULT
showSection('book');
</script>

</body>
</html>
