<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jinja Boda B Booking & Car Hire</title>

<style>
body { font-family: "Segoe UI", sans-serif; background: #f9fafb; margin: 0; }
header { background: linear-gradient(135deg, #0f766e, #14b8a6); color: white; text-align: center; padding: 20px; }
nav { display: flex; justify-content: center; gap: 10px; margin: 10px 0; }
nav button { padding: 10px 15px; border: none; border-radius: 8px; background: #0f766e; color: white; cursor: pointer; }
.container { max-width: 600px; margin: auto; padding: 20px; }
.card { background: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; }
input, select { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 10px; border: 1px solid #d1d5db; }
button.submit, button.action { width: 100%; padding: 12px; border: none; border-radius: 12px; background: #0f766e; color: white; font-weight: bold; cursor: pointer; }
.booking, .rider { background: #f3f4f6; padding: 12px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #d1d5db; }
hr { margin: 20px 0; }
</style>
</head>

<body>

<header>
<h1>Jinja Boda B Booking & Special Car Hire</h1>
<p>Ride Safe • Arrive on Time • Support Local Riders</p>
</header>

<nav>
<button onclick="showSection('book')">Book Ride</button>
<button onclick="showSection('riderLogin')">Riders / Drivers</button>
<button onclick="openAdmin()">Admin</button>
</nav>

<div class="container">

<div id="book" class="card section">
<h2>Book a Ride</h2>
<input id="custName" placeholder="Your Name">
<input id="custPhone" placeholder="Phone Number (2567xxxxxxx)">
<input id="pickup" placeholder="Pickup Location">
<input id="destination" placeholder="Destination">
<select id="rideType">
<option value="Motorcycle">Motorcycle</option>
<option value="Car">Car</option>
</select>
<select id="time"></select>
<button class="submit" onclick="bookRide()">Submit Booking</button>
</div>

<div id="riderLogin" class="card section" style="display:none;">
<h2>Rider / Admin Login</h2>
<input id="loginInput" placeholder="Bike / Car Plate or Admin PIN">
<button class="submit" onclick="riderOrAdminLogin()">Login</button>
</div>

<div id="rider" class="card section" style="display:none;">
<h2>Rider Dashboard</h2>
<input id="updatePlate" placeholder="Your Plate">
<button class="submit" onclick="updateMyLocation()">Update My Location</button>
<hr>
<div id="riderBookings"></div>
</div>

<div id="admin" class="card section" style="display:none;">
<h2>Admin Dashboard</h2>
<div id="bookingList"></div>
</div>

</div>

<script>
const ADMIN_PIN="1234";
const RATE={ Motorcycle:1500, Car:3000 };
let currentRider=null;

const getRiders=()=>JSON.parse(localStorage.getItem("riders")||"[]");
const getBookings=()=>JSON.parse(localStorage.getItem("bookings")||"[]");
const saveBookings=b=>localStorage.setItem("bookings",JSON.stringify(b));

function showSection(id){
 document.querySelectorAll(".section").forEach(s=>s.style.display="none");
 document.getElementById(id).style.display="block";
 if(id==="admin") loadAdmin();
 if(id==="rider") loadRiderBookings();
}

function openAdmin(){
 if(prompt("Enter Admin PIN")===ADMIN_PIN) showSection("admin");
 else alert("Wrong PIN");
}

function riderOrAdminLogin(){
 const v=loginInput.value.trim();
 if(v===ADMIN_PIN){showSection("admin");return;}
 const r=getRiders().find(x=>x.plate===v);
 if(!r) return alert("Not registered");
 currentRider=r; showSection("rider");
}

function haversine(lat1,lon1,lat2,lon2){
 const R=6371;
 const dLat=(lat2-lat1)*Math.PI/180;
 const dLon=(lon2-lon1)*Math.PI/180;
 const a=Math.sin(dLat/2)**2+
 Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
 Math.sin(dLon/2)**2;
 return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function sendWhatsApp(phone,msg){
 window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`,"_blank");
}

function autoAssignNearest(id){
 const bookings=getBookings();
 const b=bookings.find(x=>x.id===id);
 const riders=getRiders().filter(r=>r.type===b.type);

 const plat=parseFloat(prompt("Pickup LAT"));
 const plong=parseFloat(prompt("Pickup LNG"));
 const dlat=parseFloat(prompt("Destination LAT"));
 const dlng=parseFloat(prompt("Destination LNG"));

 const dist=haversine(plat,plong,dlat,dlng);
 const fare=Math.round(dist*RATE[b.type]);

 let nearest=null,min=Infinity;
 riders.forEach(r=>{
   const d=haversine(plat,plong,r.lat,r.lng);
   if(d<min){min=d;nearest=r;}
 });

 b.riderPlate=nearest.plate;
 b.status="Assigned";
 b.distance=dist.toFixed(2);
 b.fare=fare;

 saveBookings(bookings);
 loadAdmin();

 sendWhatsApp(b.phone,
 `Your ride is confirmed.
 Distance: ${b.distance} km
 Fare: UGX ${fare}`);

 sendWhatsApp(nearest.phone,
 `New ride assigned:
 ${b.pickup} → ${b.destination}
 Fare: UGX ${fare}`);
}

function bookRide(){
 const b=getBookings();
 b.push({
  id:Date.now(),
  customer:custName.value,
  phone:custPhone.value,
  pickup, destination,
  type:rideType.value,
  time:time.value,
  status:"Pending"
 });
 saveBookings(b);
 alert("Booking received");
}

function loadAdmin(){
 bookingList.innerHTML=getBookings().map(b=>`
 <div class="booking">
 <b>${b.customer}</b> (${b.type})<br>
 ${b.pickup} → ${b.destination}<br>
 Status: ${b.status}<br>
 Fare: ${b.fare||"—"}<br>
 ${b.status==="Pending"?
 `<button class="action" onclick="autoAssignNearest(${b.id})">
 Auto Assign + Price + Notify
 </button>`:""}
 </div>`).join("");
}

function loadRiderBookings(){
 riderBookings.innerHTML=getBookings()
 .filter(b=>b.riderPlate===currentRider.plate)
 .map(b=>`<div class="booking">
 ${b.pickup} → ${b.destination}<br>
 Fare: UGX ${b.fare}
 </div>`).join("");
}

const baseTimes=["Now","In 15 minutes","In 30 minutes"];
const carTimes=["In 2 hours","In 4 hours","In 1 day"];
function updateTimeOptions(){
 time.innerHTML="";
 baseTimes.forEach(t=>time.add(new Option(t,t)));
 if(rideType.value==="Car") carTimes.forEach(t=>time.add(new Option(t,t)));
}
rideType.addEventListener("change",updateTimeOptions);
updateTimeOptions();
showSection("book");
</script>

</body>
</html>
