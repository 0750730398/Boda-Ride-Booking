<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jinja Boda Boda Booking App</title>

<style>
body {
    font-family: "Segoe UI", sans-serif;
    background: #f9fafb;
    margin: 0;
}
header {
    background: linear-gradient(135deg, #0f766e, #14b8a6);
    color: white;
    text-align: center;
    padding: 20px;
}
nav {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 10px 0;
}
nav button {
    padding: 10px 15px;
    border: none;
    border-radius: 8px;
    background: #0f766e;
    color: white;
    cursor: pointer;
}
.container {
    max-width: 550px;
    margin: auto;
    padding: 20px;
}
.card {
    background: white;
    padding: 25px;
    border-radius: 15px;
    margin-bottom: 20px;
}
input, select {
    width: 100%;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    border: 1px solid #d1d5db;
}
button.submit {
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: 12px;
    background: #0f766e;
    color: white;
    font-weight: bold;
}
.booking, .rider {
    background: #f3f4f6;
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 10px;
    border: 1px solid #d1d5db;
}
.booking.pending { cursor:pointer; }
.booking.pending:hover { background:#e6fffa; }
</style>
</head>

<body>

<header>
<h1>Jinja Boda Boda Booking</h1>
<p>Ride Safe ‚Ä¢ Arrive on Time ‚Ä¢ Support Local Riders</p>
</header>

<nav>
<button onclick="showSection('book')">Book Ride</button>
<button onclick="showSection('rider')">Riders</button>
<button onclick="openAdmin()">Admin</button>
</nav>

<div class="container">

<!-- BOOK -->
<div id="book" class="card section">
<h2>Book a Ride</h2>
<input id="custName" placeholder="Your Name">
<input id="custPhone" placeholder="Phone Number">
<input id="pickup" placeholder="Pickup Location">
<input id="destination" placeholder="Destination">
<select id="time">
<option>Now</option>
<option>In 15 minutes</option>
<option>In 30 minutes</option>
</select>
<button class="submit" onclick="bookRide()">Submit Booking</button>
</div>

<!-- RIDERS -->
<div id="rider" class="card section" style="display:none;">
<h2>Add Rider</h2>
<input id="riderName" placeholder="Rider Name">
<input id="riderPhone" placeholder="Phone Number">
<input id="vehicle" placeholder="Bike Plate Number">
<button class="submit" onclick="addRider()">Add / Update Rider Location</button>
<hr>
<h3>Registered Riders</h3>
<div id="riderProfiles"></div>
</div>

<!-- ADMIN -->
<div id="admin" class="card section" style="display:none;">
<h2>Admin Dashboard</h2>
<p><b>Tap a pending booking to auto-assign nearest rider</b></p>
<div id="bookingList"></div>
</div>

</div>

<script>
const ADMIN_PIN = "1234";

// SECTION CONTROL
function showSection(id){
    document.querySelectorAll('.section').forEach(s=>s.style.display='none');
    document.getElementById(id).style.display='block';
    if(id==="rider") loadRiders();
    if(id==="admin") loadAdmin();
}

// ADMIN PIN
function openAdmin(){
    const pin = prompt("Enter Admin PIN");
    if(pin === ADMIN_PIN){
        showSection('admin');
    } else {
        alert("Wrong PIN");
    }
}

// STORAGE
const getRiders = () => JSON.parse(localStorage.getItem('riders')||'[]');
const getBookings = () => JSON.parse(localStorage.getItem('bookings')||'[]');

// ADD / UPDATE RIDER LOCATION
function addRider(){
    navigator.geolocation.getCurrentPosition(pos=>{
        let riders = getRiders();
        const name = riderName.value.trim();
        const phone = riderPhone.value.trim();
        const bike = vehicle.value.trim();
        if(!name||!phone||!bike){ alert("Fill all rider fields"); return; }

        const existing = riders.find(r=>r.phone===phone);
        if(existing){
            existing.lat = pos.coords.latitude;
            existing.lng = pos.coords.longitude;
        } else {
            riders.push({
                id: Date.now(),
                name, phone, bike,
                lat: pos.coords.latitude,
                lng: pos.coords.longitude
            });
        }
        localStorage.setItem('riders',JSON.stringify(riders));
        loadRiders();
        alert("Rider location updated");
    });
}

// LOAD RIDERS
function loadRiders(){
    const riders = getRiders();
    riderProfiles.innerHTML = riders.map(r=>`
        <div class="rider">
            <b>${r.name}</b><br>
            üìû ${r.phone}<br>
            üèçÔ∏è ${r.bike}<br>
            üìç Location updated
        </div>
    `).join('') || "<p>No riders</p>";
}

// BOOKING
function bookRide(){
    if(!custName.value||!custPhone.value||!pickup.value||!destination.value){
        alert("Fill all details"); return;
    }
    const bookings = getBookings();
    bookings.push({
        id: Date.now(),
        customer: custName.value,
        phone: custPhone.value,
        pickup: pickup.value,
        destination: destination.value,
        time: time.value,
        status: "Pending",
        rider: null
    });
    localStorage.setItem('bookings',JSON.stringify(bookings));
    alert("Booking received");
    custName.value=custPhone.value=pickup.value=destination.value="";
}

// DISTANCE CALCULATION
function distance(a,b){
    const R=6371;
    const dLat=(b.lat-a.lat)*Math.PI/180;
    const dLng=(b.lng-a.lng)*Math.PI/180;
    const s=Math.sin(dLat/2)**2+
    Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*
    Math.sin(dLng/2)**2;
    return R*2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));
}

// ADMIN VIEW
function loadAdmin(){
    const bookings=getBookings();
    bookingList.innerHTML = bookings.map(b=>`
        <div class="booking ${b.status==='Pending'?'pending':''}"
        onclick="${b.status==='Pending'?'assignNearest('+b.id+')':''}">
            <b>${b.customer}</b><br>
            ${b.pickup} ‚Üí ${b.destination}<br>
            ‚è∞ ${b.time}<br>
            üö¶ ${b.status}
        </div>
    `).join('') || "<p>No bookings</p>";
}

// ASSIGN NEAREST RIDER
function assignNearest(id){
    const bookings=getBookings();
    const riders=getRiders();
    const booking=bookings.find(b=>b.id===id);
    if(!riders.length){ alert("No riders available"); return; }

    navigator.geolocation.getCurrentPosition(pos=>{
        let nearest=null, min=Infinity;
        riders.forEach(r=>{
            const d=distance(
                {lat:pos.coords.latitude,lng:pos.coords.longitude},
                r
            );
            if(d<min){min=d;nearest=r;}
        });

        booking.rider=nearest;
        booking.status="Assigned";
        localStorage.setItem('bookings',JSON.stringify(bookings));

        const msg=`New ride assigned
Customer: ${booking.customer}
Phone: ${booking.phone}
Pickup: ${booking.pickup}
Destination: ${booking.destination}`;

        window.open(`https://wa.me/${nearest.phone}?text=${encodeURIComponent(msg)}`);
        loadAdmin();
    });
}

// DEFAULT
showSection('book');
</script>

</body>
</html>
