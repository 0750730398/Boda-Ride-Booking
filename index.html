<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jinja Boda Boda Booking App</title>

<style>
body {
    font-family: "Segoe UI", sans-serif;
    background: #f9fafb;
    margin: 0;
}
header {
    background: linear-gradient(135deg, #0f766e, #14b8a6);
    color: white;
    text-align: center;
    padding: 20px;
}
nav {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 10px 0;
}
nav button {
    padding: 10px 15px;
    border: none;
    border-radius: 8px;
    background: #0f766e;
    color: white;
    cursor: pointer;
}
.container {
    max-width: 550px;
    margin: auto;
    padding: 20px;
}
.card {
    background: white;
    padding: 25px;
    border-radius: 15px;
    margin-bottom: 20px;
}
input, select {
    width: 100%;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    border: 1px solid #d1d5db;
}
button.submit, button.action {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 12px;
    background: #0f766e;
    color: white;
    font-weight: bold;
    margin-top: 5px;
    cursor: pointer;
}
button.reject { background:#dc2626; }
button.complete { background:#2563eb; }

.booking, .rider {
    background: #f3f4f6;
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 10px;
    border: 1px solid #d1d5db;
}
</style>
</head>

<body>

<header>
<h1>Jinja Boda Boda Booking</h1>
<p>Ride Safe ‚Ä¢ Arrive on Time ‚Ä¢ Support Local Riders</p>
</header>

<nav>
<button onclick="showSection('book')">Book Ride</button>
<button onclick="showSection('rider')">Riders</button>
<button onclick="openAdmin()">Admin</button>
</nav>

<div class="container">

<!-- BOOK RIDE -->
<div id="book" class="card section">
<h2>Book a Ride</h2>
<input id="custName" placeholder="Your Name">
<input id="custPhone" placeholder="Phone Number">
<input id="pickup" placeholder="Pickup Location">
<input id="destination" placeholder="Destination">
<select id="time">
<option>Now</option>
<option>In 15 minutes</option>
<option>In 30 minutes</option>
</select>
<button class="submit" onclick="bookRide()">Submit Booking</button>
</div>

<!-- RIDERS -->
<div id="rider" class="card section" style="display:none;">
<h2>Add / Update Rider</h2>
<input id="riderName" placeholder="Rider Name">
<input id="riderPhone" placeholder="Phone (07XXXXXXXX)">
<input id="vehicle" placeholder="Bike Plate Number">
<button class="submit" onclick="addRider()">Save & Update Location</button>
<hr>
<h3>Registered Riders</h3>
<div id="riderProfiles"></div>
</div>

<!-- ADMIN -->
<div id="admin" class="card section" style="display:none;">
<h2>Admin Dashboard</h2>
<div id="bookingList"></div>
</div>

</div>

<script>
const ADMIN_PIN = "1234";

// SECTION CONTROL
function showSection(id){
    document.querySelectorAll('.section').forEach(s=>s.style.display='none');
    document.getElementById(id).style.display='block';
    if(id==="rider") loadRiders();
    if(id==="admin") loadAdmin();
}

// ADMIN PIN
function openAdmin(){
    const pin = prompt("Enter Admin PIN");
    if(pin === ADMIN_PIN) showSection('admin');
    else alert("Wrong PIN");
}

// STORAGE
const getRiders = () => JSON.parse(localStorage.getItem('riders')||'[]');
const getBookings = () => JSON.parse(localStorage.getItem('bookings')||'[]');

// ADD / UPDATE RIDER
function addRider(){
    navigator.geolocation.getCurrentPosition(pos=>{
        let riders = getRiders();
        const name = riderName.value.trim();
        const phone = riderPhone.value.trim();
        const bike = vehicle.value.trim();
        if(!name||!phone||!bike){ alert("Fill all fields"); return; }

        let r = riders.find(x=>x.phone===phone);
        if(r){
            r.lat = pos.coords.latitude;
            r.lng = pos.coords.longitude;
        } else {
            riders.push({
                id: Date.now(),
                name, phone, bike,
                lat: pos.coords.latitude,
                lng: pos.coords.longitude
            });
        }
        localStorage.setItem('riders',JSON.stringify(riders));
        loadRiders();
        alert("Rider saved & location updated");
    });
}

// LOAD RIDERS
function loadRiders(){
    const riders = getRiders();
    riderProfiles.innerHTML = riders.map(r=>`
        <div class="rider">
            <b>${r.name}</b><br>
            üìû ${r.phone}<br>
            üèçÔ∏è ${r.bike}
        </div>
    `).join('') || "<p>No riders yet</p>";
}

// BOOK RIDE
function bookRide(){
    if(!custName.value||!custPhone.value||!pickup.value||!destination.value){
        alert("Fill all details"); return;
    }
    const bookings = getBookings();
    bookings.push({
        id: Date.now(),
        customer: custName.value,
        phone: custPhone.value,
        pickup, destination,
        time: time.value,
        status:"Pending",
        rider:null
    });
    localStorage.setItem('bookings',JSON.stringify(bookings));
    alert("Booking received");
    custName.value=custPhone.value=pickup.value=destination.value="";
}

// DISTANCE
function distance(a,b){
    const R=6371;
    const dLat=(b.lat-a.lat)*Math.PI/180;
    const dLng=(b.lng-a.lng)*Math.PI/180;
    const s=Math.sin(dLat/2)**2+
    Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*
    Math.sin(dLng/2)**2;
    return R*2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));
}

// ADMIN VIEW
function loadAdmin(){
    const bookings = getBookings();
    bookingList.innerHTML = bookings.map(b=>`
        <div class="booking">
            <b>${b.customer}</b><br>
            ${b.pickup} ‚Üí ${b.destination}<br>
            ‚è∞ ${b.time}<br>
            üö¶ <b>${b.status}</b><br><br>

            ${b.status==="Pending"?`
                <button class="action" onclick="assignNearest(${b.id})">
                Assign Nearest Rider</button>`:""}

            ${b.status==="Assigned"?`
                <button class="action" onclick="markAccepted(${b.id})">
                Confirm Accepted</button>
                <button class="action reject" onclick="markRejected(${b.id})">
                Rejected</button>`:""}

            ${b.status==="Accepted"?`
                <button class="action complete" onclick="markCompleted(${b.id})">
                Trip Completed</button>`:""}
        </div>
    `).join('') || "<p>No bookings</p>";
}

// ASSIGN RIDER + WHATSAPP
function assignNearest(id){
    const bookings=getBookings();
    const riders=getRiders();
    const booking=bookings.find(b=>b.id===id);
    if(!riders.length){ alert("No riders"); return; }

    navigator.geolocation.getCurrentPosition(pos=>{
        let nearest=null,min=Infinity;
        riders.forEach(r=>{
            const d=distance({lat:pos.coords.latitude,lng:pos.coords.longitude},r);
            if(d<min){min=d;nearest=r;}
        });

        booking.rider=nearest;
        booking.status="Assigned";
        localStorage.setItem('bookings',JSON.stringify(bookings));

        let phone = nearest.phone.replace(/^0/,"256");
        const msg=`Hello ${nearest.name},

New boda ride assigned.

Customer: ${booking.customer}
Phone: ${booking.phone}
Pickup: ${booking.pickup}
Destination: ${booking.destination}
Time: ${booking.time}

Reply:
ACCEPT or REJECT`;

        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`,"_blank");
        loadAdmin();
    });
}

// STATUS CONTROLS
function markAccepted(id){
    const b=getBookings(); b.find(x=>x.id===id).status="Accepted";
    localStorage.setItem('bookings',JSON.stringify(b)); loadAdmin();
}
function markRejected(id){
    const b=getBookings(); 
    const bk=b.find(x=>x.id===id);
    bk.status="Rejected"; bk.rider=null;
    localStorage.setItem('bookings',JSON.stringify(b)); loadAdmin();
}
function markCompleted(id){
    const b=getBookings(); b.find(x=>x.id===id).status="Completed";
    localStorage.setItem('bookings',JSON.stringify(b)); loadAdmin();
}

// DEFAULT
showSection('book');
</script>

</body>
</html>
