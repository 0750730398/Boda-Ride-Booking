<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jinja Boda Boda Booking App</title>

<style>
body {
    font-family: "Segoe UI", sans-serif;
    background: #f9fafb;
    margin: 0;
}
header {
    background: linear-gradient(135deg, #0f766e, #14b8a6);
    color: white;
    text-align: center;
    padding: 20px;
}
nav {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 10px 0;
}
nav button {
    padding: 10px 15px;
    border: none;
    border-radius: 8px;
    background: #0f766e;
    color: white;
    cursor: pointer;
}
.container {
    max-width: 550px;
    margin: auto;
    padding: 20px;
}
.card {
    background: white;
    padding: 25px;
    border-radius: 15px;
    margin-bottom: 20px;
}
input, select {
    width: 100%;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    border: 1px solid #d1d5db;
}
button.submit, button.action {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 12px;
    background: #0f766e;
    color: white;
    font-weight: bold;
    margin-top: 5px;
    cursor: pointer;
}
button.delete { background: #dc2626; }

.booking, .rider {
    background: #f3f4f6;
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 10px;
    border: 1px solid #d1d5db;
}
</style>
</head>

<body>

<header>
<h1>Jinja Boda Boda Booking</h1>
<p>Ride Safe ‚Ä¢ Arrive on Time ‚Ä¢ Support Local Riders</p>
</header>

<nav>
<button onclick="showSection('book')">Book Ride</button>
<button onclick="showSection('riderLogin')">Riders</button>
<button onclick="openAdmin()">Admin</button>
</nav>

<div class="container">

<!-- BOOK -->
<div id="book" class="card section">
<h2>Book a Ride</h2>
<input id="custName" placeholder="Your Name">
<input id="custPhone" placeholder="Phone Number">
<input id="pickup" placeholder="Pickup Location">
<input id="destination" placeholder="Destination">
<select id="time">
<option>Now</option>
<option>In 15 minutes</option>
<option>In 30 minutes</option>
</select>
<button class="submit" onclick="bookRide()">Submit Booking</button>
</div>

<!-- RIDER LOGIN -->
<div id="riderLogin" class="card section" style="display:none;">
<h2>Rider / Admin Login</h2>
<p>Riders: enter your bike plate. Admin: enter PIN</p>
<input id="loginInput" placeholder="Bike Plate or Admin PIN">
<button class="submit" onclick="riderOrAdminLogin()">Login</button>
</div>

<!-- RIDER DASHBOARD -->
<div id="rider" class="card section" style="display:none;">
<h2>Rider Dashboard</h2>
<p>Update location only:</p>
<input id="updatePlate" placeholder="Your Bike Plate">
<button class="submit" onclick="updateMyLocation()">Update My Location</button>
<hr>
<h3>Registered Riders</h3>
<div id="riderProfiles"></div>
</div>

<!-- ADMIN DASHBOARD -->
<div id="admin" class="card section" style="display:none;">
<h2>Admin Dashboard</h2>

<h3>Add Rider (Admin Only)</h3>
<input id="riderName" placeholder="Rider Name">
<input id="riderPhone" placeholder="Phone (07XXXXXXXX)">
<input id="vehicle" placeholder="Bike Plate Number">
<button class="submit" onclick="addRider()">Add Rider</button>

<hr>
<h3>Registered Riders</h3>
<div id="riderProfilesAdmin"></div>

<hr>
<h3>Bookings</h3>
<div id="bookingList"></div>
</div>

</div>

<script>
const ADMIN_PIN = "1234";
let currentRider = null;

// SECTION CONTROL
function showSection(id){
    document.querySelectorAll('.section').forEach(s=>s.style.display='none');
    document.getElementById(id).style.display='block';
    if(id==="rider") loadRiders();
    if(id==="admin") { loadRiders(); loadAdminRiders(); loadAdmin(); }
}

// LOGIN FOR RIDER / ADMIN
function riderOrAdminLogin(){
    const val = document.getElementById('loginInput').value.trim();
    if(!val){ alert("Enter bike plate or admin PIN"); return; }

    // Admin login
    if(val === ADMIN_PIN){
        showSection('admin');
        return;
    }

    // Rider login
    const riders = getRiders();
    const rider = riders.find(r => r.bike && r.bike.trim().toLowerCase() === val.toLowerCase());

    if(rider){
        currentRider = rider;
        showSection('rider');
        document.getElementById('updatePlate').value = rider.bike;
        loadRiders();
    } else {
        alert("Bike not registered or deleted. Contact admin.");
    }
}

// STORAGE
const getRiders = () => JSON.parse(localStorage.getItem('riders')||'[]');
const getBookings = () => JSON.parse(localStorage.getItem('bookings')||'[]');

// ADMIN ADD RIDER
function addRider(){
    navigator.geolocation.getCurrentPosition(pos=>{
        let riders = getRiders();
        const bikePlate = vehicle.value.trim();
        const phoneNum = riderPhone.value.trim();

        if(riders.find(r=>r.bike && r.bike.trim().toLowerCase()===bikePlate.toLowerCase())){
            alert("Rider already exists");
            return;
        }

        riders.push({
            id: Date.now(),
            name: riderName.value.trim(),
            phone: phoneNum,
            bike: bikePlate,
            lat: pos.coords.latitude,
            lng: pos.coords.longitude
        });

        localStorage.setItem('riders',JSON.stringify(riders));
        alert("Rider added successfully");
        loadRiders();
        loadAdminRiders();
    });
}

// RIDER UPDATE LOCATION ONLY
function updateMyLocation(){
    const plate = document.getElementById('updatePlate').value.trim();
    if(!plate){ alert("Enter your bike plate"); return; }

    navigator.geolocation.getCurrentPosition(pos=>{
        let riders = getRiders();
        let rider = riders.find(r => r.bike && r.bike.trim().toLowerCase() === plate.toLowerCase());

        if(!rider){
            alert("Bike not registered. Contact admin.");
            return;
        }

        rider.lat = pos.coords.latitude;
        rider.lng = pos.coords.longitude;

        localStorage.setItem('riders',JSON.stringify(riders));
        alert("Location updated successfully");
        loadRiders();
        loadAdminRiders();
    });
}

// LOAD RIDERS FOR RIDER DASHBOARD
function loadRiders(){
    const riders = getRiders();
    document.getElementById('riderProfiles').innerHTML = riders.map(r=>`
        <div class="rider">
            <b>${r.name}</b><br>
            üìû ${r.phone}<br>
            üèçÔ∏è ${r.bike}<br>
            üìç Location active
        </div>
    `).join('') || "<p>No riders registered</p>";
}

// LOAD RIDERS FOR ADMIN DASHBOARD
function loadAdminRiders(){
    const riders = getRiders();
    document.getElementById('riderProfilesAdmin').innerHTML = riders.map(r=>`
        <div class="rider">
            <b>${r.name}</b> | üèçÔ∏è ${r.bike} | üìû ${r.phone}<br>
            <button class="delete" onclick="deleteRider('${r.bike}')">Delete Rider</button>
        </div>
    `).join('') || "<p>No riders registered</p>";
}

// DELETE RIDER (ADMIN ONLY)
function deleteRider(plate){
    if(!confirm("Are you sure you want to delete this rider?")) return;

    let riders = getRiders();
    riders = riders.filter(r => !(r.bike && r.bike.trim().toLowerCase()===plate.toLowerCase()));
    localStorage.setItem('riders',JSON.stringify(riders));
    alert("Rider deleted successfully");
    loadRiders();
    loadAdminRiders();
}

// BOOK RIDE
function bookRide(){
    if(!custName.value||!custPhone.value||!pickup.value||!destination.value){
        alert("Fill all booking details"); return;
    }
    const bookings = getBookings();
    bookings.push({
        id: Date.now(),
        customer: custName.value,
        phone: custPhone.value,
        pickup: pickup.value,
        destination: destination.value,
        time: time.value,
        status: "Pending",
        rider: null
    });
    localStorage.setItem('bookings',JSON.stringify(bookings));
    alert("Booking received");
    custName.value=custPhone.value=pickup.value=destination.value="";
}

// ADMIN BOOKINGS
function loadAdmin(){
    const bookings = getBookings();
    bookingList.innerHTML = bookings.map(b=>`
        <div class="booking">
            <b>${b.customer}</b><br>
            ${b.pickup} ‚Üí ${b.destination}<br>
            ‚è∞ ${b.time}<br>
            üö¶ <b>${b.status}</b><br>

            ${b.status==="Pending"?`
            <button class="action" onclick="assignNearest(${b.id})">
            Assign Nearest Rider</button>`:""}

            ${b.status==="Accepted"?`
            <button class="action complete" onclick="markCompleted(${b.id})">
            Trip Completed</button>`:""}
        </div>
    `).join('') || "<p>No bookings</p>";
}

// DISTANCE
function distance(a,b){
    const R=6371;
    const dLat=(b.lat-a.lat)*Math.PI/180;
    const dLng=(b.lng-a.lng)*Math.PI/180;
    const s=Math.sin(dLat/2)**2+
    Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*
    Math.sin(dLng/2)**2;
    return R*2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));
}

// ASSIGN NEAREST RIDER
function assignNearest(id){
    const bookings=getBookings();
    const riders=getRiders();
    const booking=bookings.find(b=>b.id===id);
    if(!riders.length){ alert("No riders available"); return; }

    navigator.geolocation.getCurrentPosition(pos=>{
        let nearest=null,min=Infinity;
        riders.forEach(r=>{
            const d=distance({lat:pos.coords.latitude,lng:pos.coords.longitude},r);
            if(d<min){min=d;nearest=r;}
        });

        booking.rider = nearest;
        booking.status = "Accepted"; // Rider auto-accept simplified
        localStorage.setItem('bookings',JSON.stringify(bookings));
        loadAdmin();
    });
}

// COMPLETE
function markCompleted(id){
    const b=getBookings();
    b.find(x=>x.id===id).status="Completed";
    localStorage.setItem('bookings',JSON.stringify(b));
    loadAdmin();
}

// DEFAULT
showSection('book');
</script>

</body>
</html>
