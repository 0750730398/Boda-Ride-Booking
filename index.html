<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jinja Boda B ‚Äì Ride Platform</title>

<style>
body{font-family:Segoe UI,sans-serif;background:#f9fafb;margin:0}
header{background:linear-gradient(135deg,#0f766e,#14b8a6);color:#fff;text-align:center;padding:20px}
nav{display:flex;justify-content:center;gap:10px;margin:10px;flex-wrap:wrap}
nav button{background:#0f766e;color:white;border:none;padding:10px 15px;border-radius:8px}
.container{max-width:900px;margin:auto;padding:20px}
.card{background:white;padding:20px;border-radius:15px;margin-bottom:20px}
input,select,textarea{width:100%;padding:12px;margin-bottom:10px;border-radius:10px;border:1px solid #ccc}
button{width:100%;padding:12px;border:none;border-radius:12px;background:#0f766e;color:white;font-weight:bold;margin-top:5px}
.booking{background:#f3f4f6;padding:12px;border-radius:10px;margin-bottom:10px}
.receipt{border:2px dashed #0f766e;padding:15px;border-radius:12px;background:#ecfeff}
.star{color:gold;font-size:18px}
.small{font-size:13px;color:#555}
.toggle{background:#14b8a6}
.offline{background:#dc2626}
a{color:#0f766e;font-weight:bold;text-decoration:none}
</style>
</head>

<body>

<header>
<h1>Jinja Boda B</h1>
<p>Bookings ‚Ä¢ Payments ‚Ä¢ Receipts ‚Ä¢ Ratings</p>
</header>

<nav>
<button onclick="show('book')">Book</button>
<button onclick="show('customerLogin')">Customer</button>
<button onclick="show('riderLogin')">Rider</button>
<button onclick="adminLogin()">Admin</button>
</nav>

<div class="container">

<!-- BOOK -->
<div id="book" class="card section">
<h3>Book Ride</h3>
<input id="custName" placeholder="Name">
<input id="custPhone" placeholder="Phone">
<input id="pickup" placeholder="Pickup">
<input id="destination" placeholder="Destination">
<select id="rideType"><option>Motorcycle</option><option>Car</option></select>
<select id="time"></select>
<button onclick="bookRide()">Submit</button>
</div>

<!-- CUSTOMER LOGIN -->
<div id="customerLogin" class="card section" style="display:none;">
<h3>Customer Login (OTP)</h3>
<input id="custLoginPhone" placeholder="Phone">
<button onclick="sendOTP()">Send OTP</button>
<div id="otpBox" style="display:none;">
<input id="otpInput" placeholder="OTP">
<button onclick="verifyOTP()">Verify</button>
</div>
</div>

<!-- CUSTOMER -->
<div id="customerTrack" class="card section" style="display:none;">
<h3>Current / Past Trips</h3>
<div id="customerTrips"></div>
</div>

<!-- RIDER LOGIN -->
<div id="riderLogin" class="card section" style="display:none;">
<h3>Rider Login</h3>
<input id="loginInput" placeholder="Plate">
<button onclick="riderLogin()">Login</button>
</div>

<!-- RIDER -->
<div id="rider" class="card section" style="display:none;">
<h3>Rider Dashboard</h3>
<button id="availabilityBtn" class="toggle" onclick="toggleAvailability()">üî¥ OFFLINE</button>
<div id="riderJobs"></div>
<hr>
<h3>My Ratings</h3>
<div id="riderRatings"></div>
</div>

<!-- ADMIN -->
<div id="admin" class="card section" style="display:none;">
<h3>Admin Dashboard</h3>
<button onclick="autoAssign()">üöÄ Auto Assign</button>
<div id="adminBookings"></div>
<hr>
<h3>Rider Ratings</h3>
<div id="adminRatings"></div>
</div>

</div>

<script>
const ADMIN_PIN="1234";
const RATE={Motorcycle:1500,Car:3000};

let generatedOTP=null,loggedCustomerPhone=null,currentRider=null;

const riders=()=>JSON.parse(localStorage.getItem("riders")||"[]");
const bookings=()=>JSON.parse(localStorage.getItem("bookings")||"[]");
const saveRiders=r=>localStorage.setItem("riders",JSON.stringify(r));
const saveBookings=b=>localStorage.setItem("bookings",JSON.stringify(b));

function show(id){
document.querySelectorAll(".section").forEach(s=>s.style.display="none");
document.getElementById(id).style.display="block";
if(id==="admin")loadAdmin();
}

/* OTP */
function sendOTP(){
generatedOTP=Math.floor(1000+Math.random()*9000);
alert("OTP (demo): "+generatedOTP);
otpBox.style.display="block";
}
function verifyOTP(){
if(otpInput.value==generatedOTP){
loggedCustomerPhone=custLoginPhone.value;
show("customerTrack");
loadCustomer();
}else alert("Wrong OTP");
}

/* BOOK */
function bookRide(){
navigator.geolocation.getCurrentPosition(p=>{
const b=bookings();
b.push({
id:Date.now(),
receipt:"JBB-"+Math.floor(Math.random()*100000),
customer:custName.value,
phone:custPhone.value,
pickup:pickup.value,
destination:destination.value,
type:rideType.value,
time:time.value,
lat:p.coords.latitude,lng:p.coords.longitude,
status:"Pending",
rider:null,fare:null,
rating:null,review:null,
date:new Date().toLocaleString()
});
saveBookings(b);
alert("Booking received");
});
}

/* AUTO ASSIGN */
function autoAssign(){
let b=bookings(),r=riders();
b.filter(x=>x.status==="Pending").forEach(x=>{
let best=null,min=9999;
r.filter(y=>y.type===x.type&&y.available).forEach(y=>{
const d=Math.hypot(x.lat-y.lat,x.lng-y.lng);
if(d<min){min=d;best=y;}
});
if(best){
x.rider=best.plate;
x.status="Assigned";
x.fare=Math.round(min*RATE[x.type]);
}
});
saveBookings(b);
loadAdmin();
}

/* CUSTOMER VIEW */
function loadCustomer(){
const b=bookings().filter(x=>x.phone===loggedCustomerPhone);
customerTrips.innerHTML=b.map(x=>`
<div class="receipt">
<b>${x.pickup}</b> ‚Üí ${x.destination}<br>
Fare: UGX ${x.fare||"?"}<br>
Status: ${x.status}<br>
${x.status==="Completed" && !x.rating ? `
<select onchange="rateTrip(${x.id},this.value)">
<option value="">Rate Rider</option>
<option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
</select>
<textarea placeholder="Review..." onchange="reviewTrip(${x.id},this.value)"></textarea>
<button onclick="submitRating(${x.id})">Submit Rating</button>
` : x.rating ? `
Rating: ${"‚òÖ".repeat(x.rating)}<br>
Review: ${x.review||"‚Äî"}
` : ""}
</div>`).join("");
}

/* SUBMIT RATING */
function rateTrip(id,val){const b=bookings();b.find(x=>x.id===id).rating=parseInt(val);saveBookings(b);}
function reviewTrip(id,val){const b=bookings();b.find(x=>x.id===id).review=val;saveBookings(b);}
function submitRating(id){
const b=bookings();const trip=b.find(x=>x.id===id);
const r=riders();const rider=r.find(y=>y.plate===trip.rider);
rider.ratingCount=(rider.ratingCount||0)+1;
rider.ratingAvg=((rider.ratingAvg||0)*(rider.ratingCount-1)+trip.rating)/rider.ratingCount;
saveRiders(r);saveBookings(b);
alert("Thank you for rating");
loadCustomer();
}

/* RIDER */
function riderLogin(){
const r=riders().find(x=>x.plate===loginInput.value);
if(!r)return alert("Not registered");
currentRider=r;show("rider");loadRider();
}
function toggleAvailability(){
const r=riders();const me=r.find(x=>x.plate===currentRider.plate);
me.available=!me.available;saveRiders(r);
availabilityBtn.textContent=me.available?"üü¢ ONLINE":"üî¥ OFFLINE";
availabilityBtn.className=me.available?"toggle":"toggle offline";
}
function loadRider(){
const r=riders().find(x=>x.plate===currentRider.plate);
riderRatings.innerHTML=`
Average Rating: ${r.ratingAvg? r.ratingAvg.toFixed(1):"N/A"} ‚≠ê<br>
Reviews: ${r.ratingCount||0}
`;
}

/* ADMIN */
function adminLogin(){if(prompt("PIN")===ADMIN_PIN)show("admin")}
function loadAdmin(){
adminRatings.innerHTML=riders().map(r=>`
<div class="booking">
${r.plate} ‚Äî ‚≠ê ${r.ratingAvg? r.ratingAvg.toFixed(1):"N/A"} (${r.ratingCount||0} reviews)
</div>`).join("");
}

/* TIME */
const base=["Now","15 min","30 min"],car=["2 hrs","4 hrs","1 day","1 week"];
function loadTime(){time.innerHTML="";base.forEach(t=>time.add(new Option(t,t)));if(rideType.value==="Car")car.forEach(t=>time.add(new Option(t,t)));}
rideType.onchange=loadTime;loadTime();show("book");
</script>

</body>
</html>
